<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="keywords" content="hexo,个人博客,blog" />
  <meta name="description" content="LittleY的个人博客" />
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="dns-prefetch" href="https://busuanzi.ibruce.info">
  <link rel="dns-prefetch" href="https://at.alicdn.com">
  
  
  
  <link rel="stylesheet" type="text/css" href="/./style/main.css">
	<link rel="shortcut icon" href="/favicon.ico" title="Favicon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
	<title>对象的内存布局和创建</title>
  
  
<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <canvas id="pattern-placeholder" height="230"></canvas>
<div class="navbar-header">
  <a class="blog-title" href="/">LittleY&#39;Blog</a>
  <a class="face-img" href="/">
    <img src="https://avatars.githubusercontent.com/u/47181393?v=4">
  </a>
</div>
<main>
  <div class="article-title">
    
  
  <h1 class="title">
    对象的内存布局和创建
  </h1>
  


    <ul class="article-info">
      <li>
        发布
        <time datetime="2021-05-22T06:42:30.000Z" itemprop="datePublished">2021-05-22</time>
      </li>
      <li>
        
    更新 <time datetime="2021-05-22T07:01:07.729Z" itemprop="dateUpdated">2021-05-22</time>

      </li>
      <li id="busuanzi_container_page_pv">
        阅读 <span id="busuanzi_value_page_pv"></span>
      </li>
    </ul>
  </div>
  <div class="container">
    <div class="article">
      <div class="content">
        
        <h2 id="对象的内存布局和创建"><a href="#对象的内存布局和创建" class="headerlink" title="对象的内存布局和创建"></a>对象的内存布局和创建</h2><h3 id="1-对象的内存布局"><a href="#1-对象的内存布局" class="headerlink" title="1. 对象的内存布局"></a>1. 对象的内存布局</h3><p>对象的内存布局分为3个区域：<strong>Header（对象头）</strong>、<strong>Instance Data（实例数据）</strong>、<strong>Padding（对齐填充）</strong></p>
<h4 id="Header（对象头）"><a href="#Header（对象头）" class="headerlink" title="Header（对象头）"></a>Header（对象头）</h4><ol>
<li><strong>运行时的数据（Mark Word）</strong>：如HashCode（哈希码）、GC分代年龄、锁状态标志、线程持有的锁等等</li>
<li><strong>类型指针</strong>：通过这个指针确定这个对象属于哪个类</li>
</ol>
<h4 id="Instance-Data（实例数据）"><a href="#Instance-Data（实例数据）" class="headerlink" title="Instance Data（实例数据）"></a><strong>Instance Data（实例数据）</strong></h4><p>这部分是存储真正的有效信息，也就是在程序代码中所定义的各种类型的字段内容。</p>
<h4 id="Padding（对齐填充）"><a href="#Padding（对齐填充）" class="headerlink" title="Padding（对齐填充）"></a><strong>Padding</strong>（<strong>对齐填充</strong>）</h4><p>这部分信息没有任何意义，仅仅是为了使得对象占的内存大小为8字节的整数倍。</p>
<h3 id="2-对象的创建"><a href="#2-对象的创建" class="headerlink" title="2. 对象的创建"></a>2. 对象的创建</h3><p>在语言层面，使用new关键字即可创建出一个对象。但是在虚拟机中，对象创建的创建过程则是比较复杂的。</p>
<p>(1) 首先，虚拟机运到new指令时，会去常量池检查是否存在new指令中包含的参数，比如new People(),则虚拟机首先会去常量池中检查是否有<code>Student</code>这个类的符号引用，并且检查这个类是否已经被加载了，如果没有则会执行类加载过程。</p>
<p>(2) 在类加载检查过后，接下来为对象分配内存当然是在java堆中分配。</p>
<p>(3) 内存分配完成后，虚拟机需要将分配到的内存空间都初始化为零值（不包括对象头）。如果使用TLAB，这一工作过程也许会提前值TLAB分配时进行。这一步保证了对象实例字段在Java中不赋值也可以直接使用。</p>
<p>(4) 接来下，虚拟机对对象进行必要的设置，例如这个对象属于哪个类的实例，如何找到类的元数据信息。对象的哈希吗、对象的GC年代等信息，这些信息都存放在对象头之中。</p>
<p>(5) 执行完上面工作之后，所有的字段都为0，接着执行<init>指令，把对象按照程序员的指令进行初始化，这样一个对象就完整的创建出来。</p>
<p>这就完了吗？？？？当然没有！！请往下看！</p>
<hr>
<h3 id="3-对象空间的分配"><a href="#3-对象空间的分配" class="headerlink" title="3. 对象空间的分配"></a>3. 对象空间的分配</h3><p>Java堆为对象分配内存的方式有两种：<strong>Bump the Pointer(指针碰撞)<strong>和</strong>Free List(空闲列表)</strong></p>
<p>**Bump the Pointer(指针碰撞)**：假设Java堆中的内存都放在一起，所有是使用过的内存放到一边，空闲的内存放到另一边，中间放着一个指针作为分界点的指示器，那所分配的内存就仅仅把指针相空闲空间的方向挪动一段与对象大小相等的距离，这种分配方式称为“指针碰撞”</p>
<p>**Free List(空闲列表)**：当使用内存和空闲内存交织在一起时，JVM需要维护一个列表，记录哪些内存是可用的，在给对象分配内存时从列表中找到一块足够大的内存空间划分给对象，并更新列表上的记录。这种分配方式称之为“空闲列表”</p>
<p>Java Heap内存采用哪种分配方式取决于Java Heap内存是否带有空间压缩整理的能力决定。也就是说有垃圾回收器采用哪种回收算法来决定的。当垃圾回收器采用的是标记-清理算法，如CMS垃圾回收器，那么使用的就是空闲列表的分配方式。当使用Serial、parNew等带有压缩整理过程的收集器，采用的是指针碰撞的内存分配方式</p>
<h3 id="4-对象的访问"><a href="#4-对象的访问" class="headerlink" title="4. 对象的访问"></a>4. 对象的访问</h3><p>对象的访问方式主流的有两种：<strong>句柄访问方式</strong>和<strong>直接指针访问方式</strong></p>
<h4 id="句柄访问方式"><a href="#句柄访问方式" class="headerlink" title="句柄访问方式"></a>句柄访问方式</h4><p>在Java堆中划分一块内存来作为句柄池，句柄池中包含了对象数据和对象类型的具体地址信息。通过这些信息可以访问到对象实例数据和对象类型数据。Java栈中的<code>reference</code>存储对象的句柄池地址即可。如图：</p>
<img src="https://gitee.com/littley98/My_Images/raw/master/Spring_Theory/image-20200720003421007.png" alt="image-20200720003421007" style="zoom:67%;" />

<h4 id="直接指针访问方式"><a href="#直接指针访问方式" class="headerlink" title="直接指针访问方式"></a>直接指针访问方式</h4><p><code>reference</code>中存储的就是对象地址。如图：</p>
<img src="https://gitee.com/littley98/My_Images/raw/master/Spring_Theory/image-20200720003550007.png" alt="image-20200720003550007" style="zoom: 67%;" />

<h4 id="二者优势"><a href="#二者优势" class="headerlink" title="二者优势"></a>二者优势</h4><p><strong>句柄访问</strong>方式的优势就是稳定，reference中存储的是稳定的句柄地址，在对象移动时只会改变句柄中实例数据的指针，而reference本身不被修改。</p>
<p><strong>直接访问</strong>方式的优势就是速度快，节省了指针定位的时间开销</p>
<blockquote>
<p>HotSpot虚拟机采用的是直接指针访问方式</p>
</blockquote>

      </div>
        <div class="support-author">
          <p>感谢您的阅读。 🙏
          <a href="" target="_blank">关于转载请看这里</a>
            <!--<a class="btn-pay"  href="#pay-modal">¥ 打赏支持</a>-->
          </p>
        </div>
        <!--
            <div class="like ">
              <div class="like-button">
                <a id="like-note" href="">
                  <i class="icon-heart"></i>喜欢
                </a>
              </div>
              <span id="likes-count">256</span>
            </div>
        -->
        <div class="otherLink">
          <div class="previous">
          </div>
          <div class="next">
          </div>
        </div>
        <div class="comments" id="comments">
          

        </div>
      </div>
    </div>
   </div>
</main>
<div class="footer">
  <div class="info">
    <p>
    <a target="_blank" rel="noopener" href="https://hexo.io"> Hexo </a> 强力驱动 |
      <a target="_blank" rel="noopener" href="https://github.com/Youthink/hexo-themes-yearn"> Yearn </a>
      主题
    </p>
    <p>&copy;2020-2021 LittleY的博客</p>
  </div>
</div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>//console
  var consoleConfig = '\n欢迎访问 https://littley98.github.io/ ，围观LittleY的博客(づ｡◕‿‿◕｡)づ！\n'.split(',');
  var canConsole = true;
  var consoleInfo = (function(consoleConfig) {
  if (!canConsole || !consoleConfig || consoleConfig.length < 1) {
    return;
  }
  var consoleColor = '#6190e8';
  var _console;
  var backgroundTextStyle = 'padding: 1px 5px;color: #fff;background: ' + consoleColor + ';'
  var textStyle = 'color: ' + consoleColor + ';';

  consoleConfig.map(o => {
    var num = (o.match(/%c/g) || []).length;
    if(/^http(s)?:\/\//.test(o)) {
      console.log('%c     ', 'background: url(' + o + ') no-repeat left center;font-size: 180px;');
      return;
    }
    if (num > 0) {
      var logArguments = [];
      for (var i = 0; i < num; i++) {
        if (i % 2 === 0) {
          logArguments.push(backgroundTextStyle);
        } else {
          logArguments.push(textStyle);
        }
      }
      (_console = console).log.apply(_console, ['%c' + o, textStyle].concat(logArguments));
      return;
    }
    console.log('%c' + o, textStyle);
  });
}(consoleConfig));</script><script type="text/javascript" src="/./js/main.js"></script>

  <script src="//at.alicdn.com/t/font_159214_mvtxvg9me9.js"></script>
</body>
</html>
